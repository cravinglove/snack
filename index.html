<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Snack</title>
  <style>
    .map {
      width: 800px;
      height: 600px;
      background: #ccc;
      position: relative;
    }
  </style>
</head>

<body>
  <div class="map"></div>
  <script>
    (function () {
      // 保存食物数组
      var elements = [];

      function Food(x, y, width, height, color) {
        // 横纵坐标
        this.x = x;
        this.y = y;
        // 宽高默认20
        this.width = width || 20;
        this.height = height || 20;
        // 背景颜色默认绿色
        this.color = color || 'green';
      }

      // 食物需要在地图显示，需要传地图参数
      Food.prototype.init = function (map) {
        remove();
        // 创建div放置食物
        var div = document.createElement('div');
        map.appendChild(div);
        // 设置样式
        div.style.width = this.width + 'px';
        div.style.height = this.height + 'px';
        div.style.backgroundColor = this.color;
        // 每次食物出现的位置是随机的
        // 横纵坐标随机生成
        // 先脱离文档流
        div.style.position = 'absolute';
        // 生成随机坐标
        this.x = parseInt(Math.random() * (map.offsetWidth / this.width)) * this.width;
        this.y = parseInt(Math.random() * (map.offsetHeight / this.height)) * this.height;

        div.style.left = this.x + 'px';
        div.style.top = this.y + 'px';
        // 将div放到食物数组中
        elements.push(div);
      }

      // 私有的remove函数
      function remove() {
        for (var i = 0; i < elements.length; i++) {
          var ele = elements[i];
          ele.parentNode.removeChild(ele);
          elements.splice(i, 1);
        }
      }
      // 暴露给外部
      window.Food = Food;
    }());

    (function () {
      var elements = []; // 存放小蛇的每个身体部分
      // 蛇构造函数
      function Snake(width, height, direction) {
        // 蛇每部分的宽高
        this.width = width || 20;
        this.height = height || 20;
        this.direction = direction || 'right';
        // 蛇身体
        this.body = [{
            x: 3,
            y: 2,
            color: 'red' // 头
          },
          {
            x: 2,
            y: 2,
            color: 'orange' // 身体
          },
          {
            x: 1,
            y: 2,
            color: 'orange' // 身体
          }
        ];
      }
      // 为原型添加方法，初始化蛇
      Snake.prototype.init = function (map) {
        // 删除前面的小蛇
        remove();
        // 创建div存放小蛇身体
        for (var i = 0; i < this.body.length; i++) {
          var obj = this.body[i];

          var div = document.createElement('div');
          map.appendChild(div);
          div.style.position = 'absolute';
          div.style.width = this.width + 'px';
          div.style.height = this.height + 'px';
          // 横纵坐标
          div.style.left = obj.x * this.width + 'px';
          div.style.top = obj.y * this.height + 'px';
          // 背景颜色
          div.style.backgroundColor = obj.color;
          // div加入到elements数组中
          elements.push(div);
        }
      }

      Snake.prototype.move = function (food, map) {
        var i = this.body.length - 1;
        for (; i > 0; i--) {
          this.body[i].x = this.body[i - 1].x;
          this.body[i].y = this.body[i - 1].y;
        }
        // 判断方向改变蛇头坐标位置
        switch (this.direction) {
          case 'left':
            this.body[0].x--;
            break;
          case 'right':
            this.body[0].x++;
            break;
          case 'top':
            this.body[0].y--;
            break;
          case 'bottom':
            this.body[0].y++;
            break;
        }
        // 判断吃到食物与否

        // 蛇头坐标
        var headX = this.body[0].x * this.width;
        var headY = this.body[0].y * this.height;

        // 蛇头坐标和食物坐标相等
        if (headX === food.x && headY === food.y) {
          var last = this.body[this.body.length - 1];
          // 复制最后的蛇尾，重新加入蛇数组
          this.body.push({
            x: last.x,
            y: last.y,
            color: last.color
          });
          // 删除食物，重新初始化食物
          food.init(map);
        }
      }

      function remove() {
        // 获取数组
        var i = elements.length - 1;
        for (; i >= 0; i--) {
          var ele = elements[i];
          ele.parentNode.removeChild(ele);
          elements.splice(i, 1);
        }
      }

      // 暴露蛇构造函数
      window.Snake = Snake;

    }());

    // 自调用函数---游戏对象
    (function () {
      var that = null;
      // 游戏构造函数
      function Game(map) {
        this.food = new Food(); // 食物对象
        this.snake = new Snake(); //小蛇对象
        this.map = map;
        that = this;
      }

      Game.prototype.init = function () {
        // 初始化游戏
        // 食物初始化
        this.food.init(this.map);
        // 小蛇初始化
        this.snake.init(this.map);
        // 调用小蛇自运动方法
        this.runSnake(this.food, this.map);
        // 调用按键的方法，监测键盘按下事件
        this.bindKey();
        // setInterval(function(){
        //   that.snake.move(that.food,that.map);
        //   that.snake.init(that.map);
        // },150)
      }


      Game.prototype.runSnake = function (food, map) {
        var timerId = setInterval(function () {
          this.snake.move(food, map);
          this.snake.init(map);
          // 横坐标最大值
          var maxX = map.offsetWidth / this.snake.width;
          // 纵坐标最大值
          var maxY = map.offsetHeight / this.snake.height;
          // 蛇头坐标
          var headX = this.snake.body[0].x;
          var headY = this.snake.body[0].y;
          // 判断撞墙与否
          if (headX >= maxX || headX < 0) {
            clearInterval(timerId);
            alert('游戏结束');
          }
          if (headY < 0 || headY >= maxY) {
            clearInterval(timerId);
            alert('游戏结束');
          }
        }.bind(that), 150)
      }

      Game.prototype.bindKey = function () {
        document.addEventListener('keydown', function (e) {
          switch (e.keyCode) {
            case 37:
              this.snake.direction = 'left';
              break;
            case 38:
              this.snake.direction = 'top';
              break;
            case 39:
              this.snake.direction = 'right';
              break;
            case 40:
              this.snake.direction = 'bottom';
              break;
          }
        }.bind(that), false)
      }
      window.Game = Game;
    }())

    var game = new Game(document.querySelector('.map'));
    game.init();


    // var food = new Food();
    // food.init(document.querySelector('.map'));// 首先在地图上显示小蛇
    // var snake = new Snake(); // 小蛇前进
    // snake.init(document.querySelector('.map')) // 初始化删除之前的小蛇，重新画一条小蛇
    // snake.move();
    // snake.init(document.querySelector('.map'))
    // snake.move();
    // snake.init(document.querySelector('.map'))
    // snake.move();
    // snake.init(document.querySelector('.map'))
    // snake.move();
    // snake.init(document.querySelector('.map'))
    // snake.move();
  </script>
</body>

</html>